#!/usr/bin/env bash

set -e

# deskmode utility scripts
# Mac OS power management utility scripts that uses `pmset` to toggle off and on the settings that send a laptop to the sleep mode with closed lid.
#
# inspired by this https://superuser.com/a/1571624
#
# sets pmset into a state when without a power connected machine will not go into sleep mode in a short period of time NO_SLEEP_SECONDS
# and reverts this option atumaticaly after that period of time

# settings
NO_SLEEP_SECONDS=10

echo "[deskmode]: enter password to change operating system sleep settings and shut the macbook lid after within $NO_SLEEP_SECONDS seconds"

# create temporary helper script
echo "# a helper script generated by ./deskmode script, do not run manually." > ./pm-set-no-sleep.sh
echo "sudo pmset -a disablesleep 1 &"                     >> ./pm-set-no-sleep.sh
# echo "echo \"[deskmode]: you may shout the macbook lid within $NO_SLEEP_SECONDS seconds without sending your computer to the sleep mode\"" >> ./pm-set-no-sleep.sh
echo "rm -f ./pm-set-no-sleep.sh"                       >> ./pm-set-no-sleep.sh
echo "sleep $NO_SLEEP_SECONDS"                          >> ./pm-set-no-sleep.sh
echo "sudo pmset -a disablesleep 0"                     >> ./pm-set-no-sleep.sh
echo "exit 0;"                                          >> ./pm-set-no-sleep.sh
chmod 755 ./pm-set-no-sleep.sh

# run script
osascript -e "do shell script \"./pm-set-no-sleep.sh\" with administrator privileges"
